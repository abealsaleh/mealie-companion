<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#ef6c00">
  <link rel="manifest" href="/manifest.json">
  <title>Mealie Companion</title>
  <script src="https://unpkg.com/lucide@0.468.0/dist/umd/lucide.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #fafafa;
      --surface: #ffffff;
      --surface2: #f5f5f5;
      --accent: #ef6c00;
      --accent-hover: #e65100;
      --accent-light: #fff3e0;
      --text: #212121;
      --text-muted: #757575;
      --text-dim: #9e9e9e;
      --success: #43a047;
      --success-light: #e8f5e9;
      --border: #e0e0e0;
      --radius: 12px;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }

    html, body {
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    .icon { width: 18px; height: 18px; vertical-align: -3px; }

    body {
      display: flex;
      flex-direction: column;
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom);
    }

    /* --- Nav Tabs --- */
    nav {
      display: flex;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
    }
    nav button {
      flex: 1;
      padding: 14px 0;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    nav button.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }

    /* --- Tabs content --- */
    .tab { display: none; flex-direction: column; flex: 1; overflow: hidden; }
    .tab.active { display: flex; }

    /* --- Setup screen (overlay) --- */
    #setup {
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: fixed;
      inset: 0;
      z-index: 500;
      background: var(--bg);
      padding: 24px;
      gap: 16px;
    }
    #setup.active { display: flex; }
    #setup form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      width: 100%;
    }
    #setup h2 { font-size: 22px; margin-bottom: 0; }
    #setup input[type="text"], #setup input[type="password"] {
      width: 100%;
      max-width: 400px;
      padding: 14px 16px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 16px;
    }
    #setup input[type="text"]:focus, #setup input[type="password"]:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }

    /* --- Common form elements --- */
    .form-group { padding: 16px; }
    .form-group label { display: block; font-size: 13px; color: var(--text-muted); margin-bottom: 6px; }
    .form-group input, .form-group select {
      width: 100%;
      padding: 12px 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 16px;
      -webkit-appearance: none;
    }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    .form-row { display: flex; gap: 12px; padding: 0 16px 16px; }
    .form-row .form-group { padding: 0; flex: 1; }

    select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23757575' stroke-width='2' fill='none'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 14px center; padding-right: 36px !important; }

    /* --- Buttons --- */
    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: var(--radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary { background: var(--accent); color: white; box-shadow: var(--shadow-sm); }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-primary:active { transform: scale(0.98); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-outline {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    .btn-sm { padding: 8px 16px; font-size: 14px; }
    .btn-danger { background: #c0392b; color: white; }

    /* --- Meal Plan Tab (two-column layout) --- */
    #mealplan-tab .mp-columns {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    #mealplan-tab .mp-col-plan {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      border-right: 1px solid var(--border);
      min-width: 0;
    }
    #mealplan-tab .mp-col-add {
      width: 340px;
      flex-shrink: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    @media (max-width: 720px) {
      #mealplan-tab .mp-columns { flex-direction: column-reverse; }
      #mealplan-tab .mp-col-plan { border-right: none; }
      #mealplan-tab .mp-col-add { width: 100%; flex-shrink: 1; overflow-y: visible; border-bottom: 1px solid var(--border); }
    }

    .mp-range-header {
      display: flex;
      align-items: center;
      padding: 8px 12px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      z-index: 10;
      font-weight: 600;
      font-size: 15px;
      color: var(--text-muted);
    }

    .mp-day {
      border-bottom: 1px solid var(--border);
    }
    .mp-day-header {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      background: var(--accent);
      color: white;
      font-weight: 600;
      font-size: 14px;
      position: sticky;
      top: 44px;
      z-index: 5;
    }
    .mp-day-header .day-name { flex: 1; }
    .mp-day-header .day-date { color: rgba(255,255,255,0.85); font-weight: 400; font-size: 13px; }
    .mp-day-header.today { background: var(--accent-hover); }
    .mp-day-header.today .day-date { color: rgba(255,255,255,0.9); }

    .mp-meal-group {
      padding: 6px 16px 6px 32px;
    }
    .mp-meal-type {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-dim);
      padding: 6px 0 2px;
    }
    .mp-entry {
      display: flex;
      align-items: center;
      padding: 8px 0;
      gap: 10px;
      border-bottom: 1px solid var(--border);
    }
    .mp-entry:last-child { border-bottom: none; }
    .mp-entry-icon { color: var(--accent); flex-shrink: 0; }
    .mp-entry-name { flex: 1; font-size: 15px; }
    .mp-entry-delete {
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
    }
    .mp-entry-delete:active { background: var(--surface2); color: var(--accent); }

    .mp-day-empty {
      padding: 10px 16px 10px 32px;
      color: var(--text-dim);
      font-size: 13px;
      font-style: italic;
    }

    .input-hint {
      font-size: 12px;
      color: var(--text-dim);
      padding: 0 16px 12px;
    }

    .result-card {
      margin: 0 16px 16px;
      padding: 16px;
      background: var(--success-light);
      border-radius: var(--radius);
      border-left: 4px solid var(--success);
      box-shadow: var(--shadow-sm);
    }
    .result-card.error { border-left-color: var(--accent); background: var(--accent-light); }
    .result-card h3 { font-size: 15px; margin-bottom: 4px; }
    .result-card p { font-size: 13px; color: var(--text-muted); }
    .result-card a { color: var(--accent); text-decoration: none; }

    .search-results {
      margin: 0 16px 16px;
      background: var(--surface);
      border-radius: var(--radius);
      border: 1px solid var(--border);
      max-height: 200px;
      overflow-y: auto;
      box-shadow: var(--shadow-md);
    }
    .search-results .item {
      padding: 12px 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }
    .search-results .item:last-child { border-bottom: none; }
    .search-results .item:active { background: var(--accent-light); }
    .search-results .item .slug { font-size: 12px; color: var(--text-dim); }

    /* loading spinner */
    .spinner {
      display: inline-block;
      width: 18px; height: 18px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-bar {
      display: none;
      padding: 16px;
      text-align: center;
      color: var(--text-muted);
      font-size: 14px;
    }
    .loading-bar.visible { display: block; }

    /* --- Shopping Tab --- */
    #shopping-tab .list-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      box-shadow: var(--shadow-sm);
    }
    #shopping-tab .list-header select { flex: 1; }
    #shopping-tab .list-header .btn { flex-shrink: 0; }

    .add-bar {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      position: relative;
    }
    .add-bar input { flex: 1; }
    .add-bar .btn { flex-shrink: 0; }

    .autocomplete-dropdown {
      display: none;
      position: absolute;
      left: 16px;
      right: 16px;
      top: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0 0 var(--radius) var(--radius);
      max-height: 280px;
      overflow-y: auto;
      z-index: 100;
      box-shadow: var(--shadow-md);
    }
    .autocomplete-dropdown.visible { display: block; }
    .autocomplete-dropdown .ac-item {
      padding: 12px 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      font-size: 15px;
    }
    .autocomplete-dropdown .ac-item:active { background: var(--accent-light); }
    .autocomplete-dropdown .ac-item .ac-label {
      font-size: 12px;
      color: var(--text-dim);
      margin-left: 8px;
    }
    .autocomplete-dropdown .ac-item.ac-new {
      color: var(--accent);
      font-weight: 600;
    }
    .autocomplete-dropdown .ac-item.kb-active { background: var(--accent-light); }

    .search-results .item.kb-active { background: var(--accent-light); }

    .category-select-bar {
      display: none;
      gap: 8px;
      padding: 8px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      align-items: center;
      font-size: 13px;
      color: var(--text-muted);
    }
    .category-select-bar.visible { display: flex; }
    .category-select-bar select { flex: 1; font-size: 14px; }

    .shopping-scroll {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 20px;
    }

    .category-group { margin-bottom: 4px; }
    .category-header {
      display: flex;
      align-items: center;
      padding: 10px 16px;
      background: var(--accent);
      color: white;
      cursor: pointer;
      user-select: none;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .category-header .arrow {
      margin-right: 10px;
      font-size: 12px;
      transition: transform 0.2s;
      color: rgba(255,255,255,0.8);
    }
    .category-header.collapsed .arrow { transform: rotate(-90deg); }
    .category-header .cat-name { font-weight: 600; font-size: 14px; }
    .category-header .cat-count {
      margin-left: auto;
      font-size: 12px;
      color: var(--accent);
      background: rgba(255,255,255,0.9);
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
    }

    .category-items { overflow: hidden; }
    .category-header.collapsed + .category-items { display: none; }

    .shop-item {
      display: flex;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.15s;
      min-height: 48px;
    }
    .shop-item:active { background: var(--surface2); }
    .shop-item .check-circle {
      width: 24px; height: 24px;
      border: 2px solid var(--text-dim);
      border-radius: 50%;
      margin-right: 14px;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .shop-item.checked .check-circle {
      background: var(--success);
      border-color: var(--success);
    }
    .shop-item.checked .check-circle::after {
      content: "✓";
      color: white;
      font-size: 14px;
      font-weight: bold;
    }
    .shop-item .item-text { flex: 1; font-size: 15px; }
    .shop-item .item-qty {
      font-size: 13px;
      color: var(--text-muted);
      margin-left: 8px;
    }
    .shop-item.checked .item-text {
      text-decoration: line-through;
      color: var(--text-dim);
    }
    .shop-item .item-actions {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: auto;
      flex-shrink: 0;
    }
    .shop-item.checked .item-actions { display: none; }

    .qty-stepper {
      display: flex;
      align-items: center;
      gap: 0;
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      background: var(--surface2);
    }
    .qty-stepper button {
      background: none;
      border: none;
      color: var(--accent);
      font-size: 16px;
      font-weight: 700;
      width: 28px;
      height: 28px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }
    .qty-stepper button:active { background: var(--accent-light); }
    .qty-stepper .qty-val {
      font-size: 13px;
      font-weight: 600;
      min-width: 22px;
      text-align: center;
      color: var(--text);
    }

    .item-note-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-dim);
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
    }
    .item-note-btn:active { background: var(--accent-light); color: var(--accent); }
    .item-note-btn.has-note { color: var(--accent); border-color: var(--accent); }

    .shop-item .item-label-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 11px;
      padding: 3px 8px;
      cursor: pointer;
      flex-shrink: 0;
      white-space: nowrap;
    }
    .shop-item .item-label-btn:active { background: var(--accent-light); color: var(--accent); }

    /* --- Note editor modal --- */
    .note-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 300;
      align-items: flex-end;
      justify-content: center;
    }
    .note-modal-overlay.visible { display: flex; }
    .note-modal {
      background: var(--surface);
      border-radius: var(--radius) var(--radius) 0 0;
      width: 100%;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      box-shadow: 0 -4px 24px rgba(0,0,0,0.15);
      padding: 16px;
      gap: 12px;
    }
    .note-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 600;
      font-size: 15px;
    }
    .note-modal-header button {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      display: flex;
    }
    .note-modal textarea {
      width: 100%;
      padding: 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
      resize: vertical;
      min-height: 80px;
    }
    .note-modal textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }

    /* --- Label picker modal --- */
    .label-modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      z-index: 300;
      align-items: flex-end;
      justify-content: center;
    }
    .label-modal-overlay.visible { display: flex; }
    .label-modal {
      background: var(--surface);
      border-radius: var(--radius) var(--radius) 0 0;
      width: 100%;
      max-width: 480px;
      max-height: 60vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 -4px 24px rgba(0,0,0,0.15);
    }
    .label-modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      font-size: 15px;
    }
    .label-modal-header button {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
      display: flex;
    }
    .label-modal-search {
      padding: 8px 16px;
      border-bottom: 1px solid var(--border);
    }
    .label-modal-search input {
      width: 100%;
      padding: 10px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 15px;
      color: var(--text);
    }
    .label-modal-search input:focus { outline: none; border-color: var(--accent); }
    .label-modal-list {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    .label-modal-item {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .label-modal-item:active { background: var(--accent-light); }
    .label-modal-item.active { color: var(--accent); font-weight: 600; }
    .label-modal-item .lm-check { width: 18px; color: var(--success); }
    .label-modal-item.lm-create { color: var(--accent); font-weight: 600; }
    .label-modal-item.lm-create .lm-check { color: var(--accent); }

    .checked-section {
      border-top: 2px solid var(--border);
      margin-top: 8px;
    }
    .checked-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px;
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .checked-header .btn { text-transform: none; letter-spacing: 0; }

    /* --- Logout button --- */
    .settings-btn {
      position: fixed;
      top: var(--safe-top);
      right: 12px;
      margin-top: 8px;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      z-index: 50;
      padding: 6px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .settings-btn:active { background: var(--surface2); }

    /* --- Toast notification --- */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: #333;
      color: #fff;
      padding: 12px 20px;
      border-radius: var(--radius);
      font-size: 14px;
      opacity: 0;
      transition: all 0.3s;
      z-index: 200;
      pointer-events: none;
      white-space: nowrap;
      box-shadow: var(--shadow-md);
    }
    .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

    /* --- Pull to refresh --- */
    .pull-indicator {
      text-align: center;
      padding: 12px;
      color: var(--text-muted);
      font-size: 13px;
      display: none;
    }

    /* --- Empty state --- */
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-dim);
      font-size: 15px;
    }
  </style>
</head>
<body>

<button class="settings-btn" onclick="logout()" title="Sign out"><i data-lucide="log-out" class="icon"></i></button>

<nav>
  <button class="active" onclick="switchTab('mealplan')"><i data-lucide="calendar-plus" class="icon"></i> Meal Plan</button>
  <button onclick="switchTab('shopping')"><i data-lucide="shopping-cart" class="icon"></i> Shopping</button>
</nav>

<!-- Login screen -->
<div id="setup">
  <form id="login-form" action="#" method="post" onsubmit="event.preventDefault();doLogin()">
    <div style="font-size:48px;margin-bottom:8px;text-align:center"><i data-lucide="chef-hat" style="width:48px;height:48px;color:var(--accent)"></i></div>
    <h2 style="text-align:center">Sign In</h2>
    <p style="color:var(--text-muted);text-align:center;font-size:14px;max-width:340px;margin:0 auto 16px">Log in with your Mealie account.</p>
    <input type="text" id="login-email" name="username" placeholder="Email or username" autocomplete="username">
    <input type="password" id="login-password" name="password" placeholder="Password" autocomplete="current-password">
    <label style="display:flex;align-items:center;gap:8px;color:var(--text-muted);font-size:14px;width:100%;max-width:400px">
      <input type="checkbox" id="login-remember" name="remember" checked> Remember me
    </label>
    <button type="submit" class="btn btn-primary" id="login-btn">Sign In</button>
    <div id="login-error" style="color:var(--accent);font-size:14px;display:none"></div>
    <button type="button" class="btn btn-outline btn-sm" onclick="hideSetup()" style="margin-top:8px">Cancel</button>
  </form>
</div>

<!-- Meal Plan Tab -->
<div id="mealplan-tab" class="tab active">
  <div class="mp-columns">
    <!-- Left column: Plan view -->
    <div class="mp-col-plan">
      <div class="mp-range-header">
        <span id="mp-range-label" style="flex:1;text-align:center">Next 8 Days</span>
        <button class="btn btn-outline btn-sm" onclick="loadMealPlan()" style="display:flex;align-items:center;padding:6px"><i data-lucide="refresh-cw" style="width:14px;height:14px"></i></button>
      </div>
      <div id="mp-plan-content">
        <div class="loading-bar visible"><span class="spinner"></span> Loading meal plan...</div>
      </div>
    </div>
    <!-- Right column: Add form -->
    <div class="mp-col-add">
      <div class="form-group">
        <label><i data-lucide="search" style="width:14px;height:14px;vertical-align:-2px"></i> Recipe name or URL</label>
        <input type="text" id="mp-input" placeholder="Paste URL or type recipe name..." autocomplete="off">
      </div>
      <div class="input-hint">Paste a URL to import, or type to search existing recipes</div>

      <div id="mp-search-results" class="search-results" style="display:none"></div>

      <div class="form-row">
        <div class="form-group">
          <label>Date</label>
          <input type="date" id="mp-date">
        </div>
        <div class="form-group">
          <label>Meal</label>
          <select id="mp-meal">
            <option value="breakfast">Breakfast</option>
            <option value="lunch">Lunch</option>
            <option value="dinner" selected>Dinner</option>
            <option value="side">Side</option>
            <option value="snack">Snack</option>
            <option value="dessert">Dessert</option>
            <option value="drink">Drink</option>
          </select>
        </div>
      </div>

      <div style="padding: 0 16px 16px">
        <button class="btn btn-primary" style="width:100%;display:flex;align-items:center;justify-content:center;gap:8px" id="mp-submit" onclick="submitMealPlan()">
          <i data-lucide="plus" class="icon"></i> Add to Meal Plan
        </button>
      </div>

      <div id="mp-loading" class="loading-bar">
        <span class="spinner"></span> Working...
      </div>

      <div id="mp-results"></div>
    </div>
  </div>
</div>

<!-- Shopping Tab -->
<div id="shopping-tab" class="tab">
  <div class="list-header">
    <select id="list-selector" onchange="selectList(this.value)">
      <option value="">Loading lists...</option>
    </select>
    <button class="btn btn-outline btn-sm" onclick="refreshList()" style="display:flex;align-items:center;padding:8px"><i data-lucide="refresh-cw" style="width:16px;height:16px"></i></button>
  </div>

  <div class="add-bar">
    <input type="text" id="add-item-input" placeholder="Add an item..." autocomplete="off"
           oninput="onAddItemInput()" onfocus="onAddItemInput()">
    <button class="btn btn-primary btn-sm" id="add-item-btn" onclick="addItemFromInput()" style="display:flex;align-items:center;gap:4px"><i data-lucide="plus" style="width:16px;height:16px" id="add-item-icon"></i> <span id="add-item-label">Add</span></button>
    <div class="autocomplete-dropdown" id="autocomplete-dropdown"></div>
  </div>

  <div class="category-select-bar" id="category-select-bar">
    <span>Category:</span>
    <select id="category-override">
      <option value="">Auto</option>
    </select>
  </div>

  <div class="shopping-scroll" id="shopping-scroll">
    <div class="pull-indicator" id="pull-indicator">↓ Pull to refresh</div>
    <div id="shopping-content">
      <div class="empty-state">Select a shopping list to get started</div>
    </div>
  </div>
</div>

<div class="label-modal-overlay" id="label-modal" onclick="if(event.target===this)closeLabelModal()">
  <div class="label-modal">
    <div class="label-modal-header">
      <span id="label-modal-title">Change Category</span>
      <button onclick="closeLabelModal()"><i data-lucide="x" style="width:18px;height:18px"></i></button>
    </div>
    <div class="label-modal-search">
      <input type="text" id="label-search-input" placeholder="Search categories..." oninput="filterLabelModal()" autocomplete="off">
    </div>
    <div class="label-modal-list" id="label-modal-list"></div>
  </div>
</div>

<div class="note-modal-overlay" id="note-modal" onclick="if(event.target===this)closeNoteModal()">
  <div class="note-modal">
    <div class="note-modal-header">
      <span id="note-modal-title">Edit Note</span>
      <button onclick="closeNoteModal()"><i data-lucide="x" style="width:18px;height:18px"></i></button>
    </div>
    <textarea id="note-modal-input" placeholder="Add a note..."></textarea>
    <button class="btn btn-primary" onclick="saveNote()" style="display:flex;align-items:center;justify-content:center;gap:8px">
      <i data-lucide="check" class="icon"></i> Save
    </button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ─── Token storage (localStorage if "Remember me", sessionStorage otherwise) ───
function getTokenStorage() {
  return localStorage.getItem('mealie_remember') === 'true' ? localStorage : sessionStorage;
}
function saveToken(token) {
  accessToken = token;
  getTokenStorage().setItem('mealie_access_token', token);
}
function clearToken() {
  accessToken = '';
  localStorage.removeItem('mealie_access_token');
  sessionStorage.removeItem('mealie_access_token');
}

// ─── State ───
let accessToken = localStorage.getItem('mealie_access_token') || sessionStorage.getItem('mealie_access_token') || '';
let shoppingLists = [];
let activeListId = localStorage.getItem('mealie_active_list') || '';
let activeListItems = [];
let allLabels = [];
let labelMap = {};  // id → {name, ...}
let selectedFood = null; // {id, name, labelId} from autocomplete
let searchTimeout = null;
let acSearchTimeout = null;
let refreshTimer = null;
let acKbIndex = -1;  // keyboard-highlighted index in shopping autocomplete
let mpKbIndex = -1;  // keyboard-highlighted index in recipe search results
const PLAN_DAYS = 8; // show today + 7 more days

// ─── Init ───
document.addEventListener('DOMContentLoaded', () => {
  if (!accessToken) {
    showSetup();
  } else {
    init();
  }
  document.getElementById('mp-date').value = todayStr();
  setupPullToRefresh();
  document.getElementById('add-item-input').addEventListener('keydown', (e) => {
    const dropdown = document.getElementById('autocomplete-dropdown');
    const items = dropdown.querySelectorAll('.ac-item');
    if (dropdown.classList.contains('visible') && items.length > 0) {
      if (e.key === 'ArrowDown') { e.preventDefault(); acKbIndex = Math.min(acKbIndex + 1, items.length - 1); highlightAcItem(items); return; }
      if (e.key === 'ArrowUp') { e.preventDefault(); acKbIndex = Math.max(acKbIndex - 1, -1); highlightAcItem(items); return; }
      if (e.key === 'Enter' && acKbIndex >= 0) { e.preventDefault(); items[acKbIndex].click(); return; }
      if (e.key === 'Escape') { dropdown.classList.remove('visible'); acKbIndex = -1; return; }
    }
    if (e.key === 'Enter') addItemFromInput();
  });
  document.getElementById('mp-input').addEventListener('input', onMpInput);
  document.getElementById('mp-input').addEventListener('keydown', (e) => {
    const resultsEl = document.getElementById('mp-search-results');
    const items = resultsEl.querySelectorAll('.item');
    if (resultsEl.style.display === 'block' && items.length > 0) {
      if (e.key === 'ArrowDown') { e.preventDefault(); mpKbIndex = Math.min(mpKbIndex + 1, items.length - 1); highlightMpItem(items); return; }
      if (e.key === 'ArrowUp') { e.preventDefault(); mpKbIndex = Math.max(mpKbIndex - 1, -1); highlightMpItem(items); return; }
      if (e.key === 'Enter' && mpKbIndex >= 0) { e.preventDefault(); items[mpKbIndex].click(); return; }
      if (e.key === 'Escape') { resultsEl.style.display = 'none'; mpKbIndex = -1; return; }
    }
    if (e.key === 'Enter') submitMealPlan();
  });
  // Close autocomplete on outside tap
  document.addEventListener('click', (e) => {
    if (!e.target.closest('.add-bar')) {
      document.getElementById('autocomplete-dropdown').classList.remove('visible');
    }
  });
});

async function init() {
  hideSetup();
  restoreActiveTab();
  try {
    await Promise.all([loadLabels(), loadShoppingLists(), loadMealPlan()]);
    populateCategoryOverride();
  } catch (err) {
    console.error('Init error:', err);
    if (err.message && err.message.includes('401')) {
      // Token expired, try refresh
      const refreshed = await tryRefreshToken();
      if (refreshed) {
        init();
        return;
      }
      logout();
      toast('Session expired - please sign in again');
    } else {
      toast('Connection error');
    }
  }
}

// ─── API helper ───
async function api(path, opts = {}) {
  const resp = await fetch('/api' + path, {
    ...opts,
    headers: {
      'Authorization': 'Bearer ' + accessToken,
      'Content-Type': 'application/json',
      'Accept': 'application/json',
      ...(opts.headers || {}),
    },
    body: opts.body ? JSON.stringify(opts.body) : undefined,
  });
  if (resp.status === 401) {
    // Try token refresh once
    const refreshed = await tryRefreshToken();
    if (refreshed) {
      // Retry the original request with new token
      const retry = await fetch('/api' + path, {
        ...opts,
        headers: {
          'Authorization': 'Bearer ' + accessToken,
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          ...(opts.headers || {}),
        },
        body: opts.body ? JSON.stringify(opts.body) : undefined,
      });
      if (!retry.ok) {
        const text = await retry.text();
        throw new Error(`API ${retry.status}: ${text}`);
      }
      const ct = retry.headers.get('content-type');
      return ct && ct.includes('application/json') ? retry.json() : retry.text();
    }
    logout();
    toast('Session expired - please sign in again');
    throw new Error('API 401: Unauthorized');
  }
  if (!resp.ok) {
    const text = await resp.text();
    throw new Error(`API ${resp.status}: ${text}`);
  }
  const contentType = resp.headers.get('content-type');
  if (contentType && contentType.includes('application/json')) {
    return resp.json();
  }
  return resp.text();
}

// ─── Auth ───
async function doLogin() {
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  const remember = document.getElementById('login-remember').checked;
  const errEl = document.getElementById('login-error');
  const btn = document.getElementById('login-btn');

  if (!email || !password) {
    errEl.textContent = 'Please enter email and password';
    errEl.style.display = 'block';
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Signing in...';
  errEl.style.display = 'none';

  try {
    const body = new URLSearchParams();
    body.append('username', email);
    body.append('password', password);
    body.append('remember_me', remember.toString());

    const resp = await fetch('/api/auth/token', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: body,
    });

    if (!resp.ok) {
      const data = await resp.json().catch(() => ({}));
      throw new Error(data.detail || 'Invalid email or password');
    }

    const data = await resp.json();
    localStorage.setItem('mealie_remember', remember.toString());
    saveToken(data.access_token);
    scheduleTokenRefresh();
    document.getElementById('login-password').value = '';
    toast('Signed in');
    init();
  } catch (err) {
    errEl.textContent = err.message;
    errEl.style.display = 'block';
  } finally {
    btn.disabled = false;
    btn.textContent = 'Sign In';
  }
}

async function tryRefreshToken() {
  try {
    const resp = await fetch('/api/auth/refresh', {
      headers: { 'Authorization': 'Bearer ' + accessToken },
    });
    if (!resp.ok) return false;
    const data = await resp.json();
    saveToken(data.access_token);
    scheduleTokenRefresh();
    return true;
  } catch {
    return false;
  }
}

function scheduleTokenRefresh() {
  clearTimeout(refreshTimer);
  // Refresh every 20 minutes (tokens typically expire in ~30 min)
  refreshTimer = setTimeout(async () => {
    const ok = await tryRefreshToken();
    if (!ok) {
      logout();
      toast('Session expired - please sign in again');
    }
  }, 20 * 60 * 1000);
}

function logout() {
  clearToken();
  clearTimeout(refreshTimer);
  showSetup();
}

function showSetup() {
  document.getElementById('setup').classList.add('active');
  document.getElementById('login-error').style.display = 'none';
}
function hideSetup() {
  document.getElementById('setup').classList.remove('active');
}

// ─── Tab switching ───
function switchTab(name) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById(name + '-tab').classList.add('active');
  document.querySelector(`nav button[onclick*="${name}"]`).classList.add('active');
  localStorage.setItem('mealie_active_tab', name);
  if (name === 'shopping' && activeListId) refreshList();
}

function restoreActiveTab() {
  const saved = localStorage.getItem('mealie_active_tab');
  if (saved && saved !== 'mealplan') switchTab(saved);
}

// ─── Helpers ───
function todayStr() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('visible');
  setTimeout(() => el.classList.remove('visible'), 2500);
}
function isUrl(s) {
  return /^https?:\/\//i.test(s.trim());
}
function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ═══════════════════════════════════
// ─── MEAL PLAN TAB ───
// ═══════════════════════════════════

const MEAL_ORDER = ['breakfast', 'lunch', 'dinner', 'side', 'snack', 'dessert', 'drink'];
const MEAL_ICONS = {
  breakfast: 'sunrise', lunch: 'sun', dinner: 'moon', side: 'salad',
  snack: 'cookie', dessert: 'cake-slice', drink: 'cup-soda',
};
const DAY_NAMES = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
const DAY_SHORT = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
const MONTH_SHORT = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

function getPlanRange() {
  const start = new Date();
  start.setHours(0, 0, 0, 0);
  const end = new Date(start);
  end.setDate(start.getDate() + PLAN_DAYS - 1);
  return { start, end };
}

function formatDateParam(d) {
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

function getRangeLabel() {
  const { start, end } = getPlanRange();
  return `${MONTH_SHORT[start.getMonth()]} ${start.getDate()} – ${MONTH_SHORT[end.getMonth()]} ${end.getDate()}`;
}

async function loadMealPlan() {
  const { start, end } = getPlanRange();
  const content = document.getElementById('mp-plan-content');
  content.innerHTML = '<div class="loading-bar visible"><span class="spinner"></span> Loading...</div>';
  document.getElementById('mp-range-label').textContent = getRangeLabel();

  try {
    const data = await api(`/households/mealplans?start_date=${formatDateParam(start)}&end_date=${formatDateParam(end)}&perPage=50&page=1`);
    const entries = data.items || [];
    renderMealPlan(start, entries);
  } catch (err) {
    content.innerHTML = '<div class="empty-state">Failed to load meal plan</div>';
  }
}

function renderMealPlan(rangeStart, entries) {
  const content = document.getElementById('mp-plan-content');
  const todayS = todayStr();

  // Group entries by date
  const byDate = {};
  entries.forEach(e => {
    if (!byDate[e.date]) byDate[e.date] = [];
    byDate[e.date].push(e);
  });

  let html = '';
  for (let i = 0; i < PLAN_DAYS; i++) {
    const d = new Date(rangeStart);
    d.setDate(rangeStart.getDate() + i);
    const dateStr = formatDateParam(d);
    const isToday = dateStr === todayS;
    const dayEntries = byDate[dateStr] || [];
    const dayLabel = isToday ? 'Today' : (i === 1 ? 'Tomorrow' : DAY_NAMES[d.getDay()]);

    html += `<div class="mp-day">`;
    html += `<div class="mp-day-header ${isToday ? 'today' : ''}">
      <span class="day-name">${dayLabel}</span>
      <span class="day-date">${MONTH_SHORT[d.getMonth()]} ${d.getDate()}</span>
    </div>`;

    if (dayEntries.length === 0) {
      html += `<div class="mp-day-empty">No meals planned</div>`;
    } else {
      // Group by meal type, sorted
      const byMeal = {};
      dayEntries.forEach(e => {
        const type = e.entryType || 'dinner';
        if (!byMeal[type]) byMeal[type] = [];
        byMeal[type].push(e);
      });

      const sortedMeals = Object.keys(byMeal).sort((a, b) =>
        MEAL_ORDER.indexOf(a) - MEAL_ORDER.indexOf(b)
      );

      html += '<div class="mp-meal-group">';
      sortedMeals.forEach(mealType => {
        html += `<div class="mp-meal-type">${escHtml(mealType)}</div>`;
        byMeal[mealType].forEach(entry => {
          const name = entry.recipe?.name || entry.title || '(untitled)';
          const icon = MEAL_ICONS[mealType] || 'utensils';
          html += `
            <div class="mp-entry">
              <span class="mp-entry-icon"><i data-lucide="${icon}" style="width:16px;height:16px"></i></span>
              <span class="mp-entry-name">${escHtml(name)}</span>
              <button class="mp-entry-delete" onclick="event.stopPropagation();deleteMealEntry(${entry.id})" title="Remove">
                <i data-lucide="x" style="width:14px;height:14px"></i>
              </button>
            </div>
          `;
        });
      });
      html += '</div>';
    }
    html += '</div>';
  }

  content.innerHTML = html;
  initIcons();
}

async function deleteMealEntry(entryId) {
  try {
    await api(`/households/mealplans/${entryId}`, { method: 'DELETE' });
    toast('Removed from meal plan');
    loadMealPlan();
  } catch (err) {
    toast('Failed to remove entry');
  }
}

function onMpInput() {
  const val = document.getElementById('mp-input').value.trim();
  const resultsEl = document.getElementById('mp-search-results');
  if (isUrl(val) || val.length < 2) {
    resultsEl.style.display = 'none';
    return;
  }
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(() => searchRecipes(val), 300);
}

async function searchRecipes(query) {
  const resultsEl = document.getElementById('mp-search-results');
  mpKbIndex = -1;
  try {
    const data = await api(`/recipes?search=${encodeURIComponent(query)}&perPage=5&page=1`);
    const items = data.items || [];
    if (items.length === 0) {
      resultsEl.style.display = 'none';
      return;
    }
    resultsEl.innerHTML = items.map(r => `
      <div class="item" onclick="selectRecipe('${escHtml(r.slug)}', '${escHtml(r.name)}')">
        ${escHtml(r.name)}
        <div class="slug">${escHtml(r.slug)}</div>
      </div>
    `).join('');
    resultsEl.style.display = 'block';
  } catch (e) {
    resultsEl.style.display = 'none';
  }
}

function selectRecipe(slug, name) {
  document.getElementById('mp-input').value = name;
  document.getElementById('mp-input').dataset.selectedSlug = slug;
  document.getElementById('mp-search-results').style.display = 'none';
}

async function submitMealPlan() {
  const input = document.getElementById('mp-input');
  const val = input.value.trim();
  if (!val) return;

  const date = document.getElementById('mp-date').value;
  const entryType = document.getElementById('mp-meal').value;
  const btn = document.getElementById('mp-submit');
  const loading = document.getElementById('mp-loading');

  btn.disabled = true;
  loading.classList.add('visible');

  try {
    let slug, recipeId, recipeName;

    if (isUrl(val)) {
      loading.querySelector('span').nextSibling.textContent = ' Importing from URL...';
      const result = await api('/recipes/create/url', { method: 'POST', body: { url: val, includeTags: false } });
      slug = typeof result === 'string' ? result : result.slug || result;
      if (typeof slug === 'string') slug = slug.replace(/^"|"$/g, '');
      const recipe = await api(`/recipes/${slug}`);
      recipeId = recipe.id;
      recipeName = recipe.name;
    } else if (input.dataset.selectedSlug) {
      slug = input.dataset.selectedSlug;
      const recipe = await api(`/recipes/${slug}`);
      recipeId = recipe.id;
      recipeName = recipe.name;
      delete input.dataset.selectedSlug;
    } else {
      loading.querySelector('span').nextSibling.textContent = ' Creating recipe...';
      const result = await api('/recipes', { method: 'POST', body: { name: val } });
      slug = typeof result === 'string' ? result : result.slug || result;
      if (typeof slug === 'string') slug = slug.replace(/^"|"$/g, '');
      const recipe = await api(`/recipes/${slug}`);
      recipeId = recipe.id;
      recipeName = recipe.name;
    }

    loading.querySelector('span').nextSibling.textContent = ' Adding to meal plan...';
    await api('/households/mealplans', {
      method: 'POST',
      body: { date, entryType, recipeId },
    });

    input.value = '';
    document.getElementById('mp-search-results').style.display = 'none';
    toast(`Added "${recipeName}" to ${entryType}`);
    loadMealPlan();
  } catch (err) {
    showMealPlanError(err.message);
  } finally {
    btn.disabled = false;
    loading.classList.remove('visible');
  }
}

function showMealPlanError(msg) {
  const el = document.getElementById('mp-results');
  el.innerHTML = `
    <div class="result-card error">
      <h3><i data-lucide="circle-x" style="width:16px;height:16px;vertical-align:-3px;color:var(--accent)"></i> Error</h3>
      <p>${escHtml(msg)}</p>
    </div>
  `;
  initIcons();
  setTimeout(() => { el.innerHTML = ''; }, 4000);
}

// ═══════════════════════════════════
// ─── SHOPPING TAB ───
// ═══════════════════════════════════

async function loadLabels() {
  const data = await api('/groups/labels');
  allLabels = (data.items || data);
  labelMap = {};
  allLabels.forEach(l => { labelMap[l.id] = l; });
}

async function loadShoppingLists() {
  const data = await api('/households/shopping/lists');
  shoppingLists = data.items || data;
  const sel = document.getElementById('list-selector');
  sel.innerHTML = shoppingLists.map(l =>
    `<option value="${l.id}" ${l.id === activeListId ? 'selected' : ''}>${escHtml(l.name)}</option>`
  ).join('');
  if (!activeListId && shoppingLists.length > 0) {
    activeListId = shoppingLists[0].id;
  }
  if (activeListId) selectList(activeListId);
}

function populateCategoryOverride() {
  const sel = document.getElementById('category-override');
  sel.innerHTML = '<option value="">Auto / None</option>' +
    allLabels.sort((a,b) => a.name.localeCompare(b.name))
      .map(l => `<option value="${l.id}">${escHtml(l.name)}</option>`)
      .join('');
}

async function selectList(id) {
  activeListId = id;
  localStorage.setItem('mealie_active_list', id);
  await refreshList();
}

async function refreshList() {
  if (!activeListId) return;
  const content = document.getElementById('shopping-content');
  content.innerHTML = '<div class="loading-bar visible"><span class="spinner"></span> Loading...</div>';
  try {
    const data = await api(`/households/shopping/lists/${activeListId}`);
    activeListItems = data.listItems || [];
    renderShoppingList();
  } catch (err) {
    content.innerHTML = `<div class="empty-state">Error loading list</div>`;
    toast('Failed to load list');
  }
}

function getItemDisplayName(item) {
  if (item.food?.name) return item.food.name;
  if (item.note) return item.note;
  if (item.display) return item.display;
  return '(unnamed)';
}

function renderShoppingList() {
  const content = document.getElementById('shopping-content');
  const unchecked = activeListItems.filter(i => !i.checked);
  const checked = activeListItems.filter(i => i.checked);

  if (unchecked.length === 0 && checked.length === 0) {
    content.innerHTML = '<div class="empty-state">List is empty. Add items above!</div>';
    return;
  }

  // Group unchecked by label
  const groups = {};
  unchecked.forEach(item => {
    const labelName = item.label?.name || item.food?.label?.name || 'Other';
    if (!groups[labelName]) groups[labelName] = [];
    groups[labelName].push(item);
  });

  const sortedGroups = Object.keys(groups).sort((a, b) => {
    if (a === 'Other') return 1;
    if (b === 'Other') return -1;
    return a.localeCompare(b);
  });

  let html = '';
  sortedGroups.forEach(groupName => {
    const items = groups[groupName];
    html += `
      <div class="category-group">
        <div class="category-header" onclick="this.classList.toggle('collapsed')">
          <span class="arrow">▼</span>
          <span class="cat-name">${escHtml(groupName)}</span>
          <span class="cat-count">${items.length}</span>
        </div>
        <div class="category-items">
          ${items.map(i => renderItem(i, false)).join('')}
        </div>
      </div>
    `;
  });

  if (checked.length > 0) {
    html += `
      <div class="checked-section">
        <div class="checked-header">
          <span>Checked (${checked.length})</span>
          <button class="btn btn-outline btn-sm" onclick="clearCheckedItems()">Clear checked</button>
        </div>
        ${checked.map(i => renderItem(i, true)).join('')}
      </div>
    `;
  }

  content.innerHTML = html;
  initIcons();
}

function renderItem(item, isChecked) {
  const name = getItemDisplayName(item);
  const qty = item.quantity || 1;
  const itemNote = item.note || '';
  // Show note inline only if item is food-linked and has a separate note
  const inlineNote = item.food?.name && itemNote ? itemNote : '';
  const labelName = item.label?.name || item.food?.label?.name || '';
  const hasNote = !!itemNote;
  return `
    <div class="shop-item ${isChecked ? 'checked' : ''}">
      <div class="check-circle" onclick="toggleItem('${item.id}', ${!isChecked})"></div>
      <span class="item-text" onclick="toggleItem('${item.id}', ${!isChecked})">${escHtml(name)}${inlineNote ? ` <span style="color:var(--text-dim);font-size:13px">(${escHtml(inlineNote)})</span>` : ''}</span>
      <div class="item-actions">
        <div class="qty-stepper">
          <button onclick="event.stopPropagation();adjustQty('${item.id}',-1)" title="Decrease">−</button>
          <span class="qty-val">${qty}</span>
          <button onclick="event.stopPropagation();adjustQty('${item.id}',1)" title="Increase">+</button>
        </div>
        <button class="item-note-btn ${hasNote ? 'has-note' : ''}" onclick="event.stopPropagation();openNoteModal('${item.id}')" title="${hasNote ? 'Edit note' : 'Add note'}">
          <i data-lucide="message-square" style="width:14px;height:14px"></i>
        </button>
        <button class="item-label-btn" onclick="event.stopPropagation();openLabelModal('${item.id}')">${labelName ? escHtml(labelName) : 'No label'}</button>
      </div>
    </div>
  `;
}

async function toggleItem(itemId, checked) {
  const item = activeListItems.find(i => i.id === itemId);
  if (!item) return;
  item.checked = checked;
  renderShoppingList();

  try {
    await api(`/households/shopping/items/${itemId}`, {
      method: 'PUT',
      body: { ...item, checked },
    });
  } catch (err) {
    item.checked = !checked;
    renderShoppingList();
    toast('Failed to update item');
  }
}

async function adjustQty(itemId, delta) {
  const item = activeListItems.find(i => i.id === itemId);
  if (!item) return;
  const oldQty = item.quantity || 1;
  const newQty = Math.max(1, oldQty + delta);
  if (newQty === oldQty) return;
  item.quantity = newQty;
  renderShoppingList();
  try {
    await api(`/households/shopping/items/${itemId}`, {
      method: 'PUT',
      body: { ...item, quantity: newQty },
    });
  } catch (err) {
    item.quantity = oldQty;
    renderShoppingList();
    toast('Failed to update quantity');
  }
}

let noteEditItemId = null;

function openNoteModal(itemId) {
  noteEditItemId = itemId;
  const item = activeListItems.find(i => i.id === itemId);
  if (!item) return;
  const name = getItemDisplayName(item);
  document.getElementById('note-modal-title').textContent = name;
  document.getElementById('note-modal-input').value = item.note || '';
  document.getElementById('note-modal').classList.add('visible');
  setTimeout(() => document.getElementById('note-modal-input').focus(), 100);
}

function closeNoteModal() {
  document.getElementById('note-modal').classList.remove('visible');
  noteEditItemId = null;
}

async function saveNote() {
  const item = activeListItems.find(i => i.id === noteEditItemId);
  if (!item) return;
  const newNote = document.getElementById('note-modal-input').value.trim();
  const oldNote = item.note;
  item.note = newNote;
  closeNoteModal();
  renderShoppingList();
  try {
    await api(`/households/shopping/items/${item.id}`, {
      method: 'PUT',
      body: { ...item, note: newNote },
    });
  } catch (err) {
    item.note = oldNote;
    renderShoppingList();
    toast('Failed to update note');
  }
}

async function clearCheckedItems() {
  const checked = activeListItems.filter(i => i.checked);
  if (checked.length === 0) return;

  for (const item of checked) {
    try {
      await api(`/households/shopping/items/${item.id}`, { method: 'DELETE' });
    } catch (e) {
      console.error('Failed to delete item:', e);
    }
  }

  activeListItems = activeListItems.filter(i => !i.checked);
  renderShoppingList();
  toast(`Cleared ${checked.length} items`);
}

// ─── Autocomplete (via Foods API) ───
function onAddItemInput() {
  const val = document.getElementById('add-item-input').value.trim();
  const dropdown = document.getElementById('autocomplete-dropdown');
  const catBar = document.getElementById('category-select-bar');
  selectedFood = null;

  if (val.length < 2) {
    dropdown.classList.remove('visible');
    catBar.classList.remove('visible');
    return;
  }

  catBar.classList.add('visible');
  clearTimeout(acSearchTimeout);
  acSearchTimeout = setTimeout(() => searchFoods(val), 200);
}

async function searchFoods(query) {
  const dropdown = document.getElementById('autocomplete-dropdown');
  acKbIndex = -1;
  try {
    const data = await api(`/foods?search=${encodeURIComponent(query)}&perPage=8&page=1`);
    const foods = data.items || [];

    const rawVal = document.getElementById('add-item-input').value.trim();
    let html = foods.map(f => {
      const labelName = f.label?.name || '';
      const fData = escHtml(JSON.stringify({ id: f.id, name: f.name, labelId: f.labelId || '' }));
      return `
        <div class="ac-item" onclick='selectFoodItem(${fData})'>
          ${escHtml(f.name)}
          ${labelName ? `<span class="ac-label">${escHtml(labelName)}</span>` : ''}
        </div>
      `;
    }).join('');

    html += `<div class="ac-item ac-new" onclick="addItemDirect()">+ Add "${escHtml(rawVal)}" as new item</div>`;

    dropdown.innerHTML = html;
    dropdown.classList.add('visible');
  } catch (e) {
    dropdown.classList.remove('visible');
  }
}

function selectFoodItem(food) {
  document.getElementById('add-item-input').value = food.name;
  document.getElementById('autocomplete-dropdown').classList.remove('visible');
  selectedFood = food;
  if (food.labelId) {
    document.getElementById('category-override').value = food.labelId;
  }
  addItemFromInput();
}

function setAddButtonLoading(loading) {
  const btn = document.getElementById('add-item-btn');
  const icon = document.getElementById('add-item-icon');
  const label = document.getElementById('add-item-label');
  if (loading) {
    btn.disabled = true;
    icon.style.display = 'none';
    label.innerHTML = '<span class="spinner" style="width:14px;height:14px;border-width:2px;margin:0"></span>';
  } else {
    btn.disabled = false;
    icon.style.display = '';
    label.textContent = 'Add';
  }
}

async function addItemFromInput() {
  const input = document.getElementById('add-item-input');
  const text = input.value.trim();
  if (!text) return;

  const overrideLabel = document.getElementById('category-override').value;
  document.getElementById('autocomplete-dropdown').classList.remove('visible');
  document.getElementById('category-select-bar').classList.remove('visible');
  setAddButtonLoading(true);

  try {
    const body = {
      shoppingListId: activeListId,
      checked: false,
    };

    const hasLabel = overrideLabel || (selectedFood && selectedFood.labelId);

    if (selectedFood) {
      body.foodId = selectedFood.id;
      if (overrideLabel && overrideLabel !== selectedFood.labelId) {
        body.labelId = overrideLabel;
      }
    } else {
      body.note = text;
      if (overrideLabel) {
        body.labelId = overrideLabel;
      }
    }

    await api('/households/shopping/items', {
      method: 'POST',
      body,
    });
    input.value = '';
    selectedFood = null;
    document.getElementById('category-override').value = '';
    toast(`Added "${text}"`);
    await refreshList();

    // If item had no category, prompt user to pick one
    if (!hasLabel) {
      const added = activeListItems.find(i =>
        (!i.checked) && (
          (i.food?.name && i.food.name.toLowerCase() === text.toLowerCase()) ||
          (i.note && i.note.toLowerCase() === text.toLowerCase())
        )
      );
      if (added) {
        openLabelModal(added.id);
      }
    }
  } catch (err) {
    toast('Failed to add item');
  } finally {
    setAddButtonLoading(false);
  }
}

function addItemDirect() {
  selectedFood = null;
  document.getElementById('autocomplete-dropdown').classList.remove('visible');
  addItemFromInput();
}

// ─── Label picker modal ───
let labelEditItemId = null;

function openLabelModal(itemId) {
  labelEditItemId = itemId;
  const item = activeListItems.find(i => i.id === itemId);
  if (!item) return;

  const currentLabelId = item.labelId || item.label?.id || item.food?.label?.id || null;
  const name = getItemDisplayName(item);
  document.getElementById('label-modal-title').textContent = name;

  const list = document.getElementById('label-modal-list');
  let html = `<div class="label-modal-item ${!currentLabelId ? 'active' : ''}" onclick="setItemLabel(null)">
    <span class="lm-check">${!currentLabelId ? '✓' : ''}</span> No label
  </div>`;
  allLabels.sort((a,b) => a.name.localeCompare(b.name)).forEach(l => {
    const isActive = currentLabelId === l.id;
    html += `<div class="label-modal-item ${isActive ? 'active' : ''}" onclick="setItemLabel('${l.id}')">
      <span class="lm-check">${isActive ? '✓' : ''}</span> ${escHtml(l.name)}
    </div>`;
  });
  list.innerHTML = html;

  document.getElementById('label-modal').classList.add('visible');
  const searchInput = document.getElementById('label-search-input');
  searchInput.value = '';
  setTimeout(() => searchInput.focus(), 100);
}

function closeLabelModal() {
  document.getElementById('label-modal').classList.remove('visible');
  labelEditItemId = null;
}

async function setItemLabel(labelId) {
  const item = activeListItems.find(i => i.id === labelEditItemId);
  if (!item) return;
  closeLabelModal();

  const oldLabelId = item.labelId;
  const oldLabel = item.label;
  item.labelId = labelId;
  item.label = labelId ? labelMap[labelId] || { id: labelId, name: '...' } : null;
  renderShoppingList();

  try {
    await api(`/households/shopping/items/${item.id}`, {
      method: 'PUT',
      body: { ...item, labelId: labelId || null },
    });
    // Also update the food's label in Mealie so future uses inherit it
    const foodId = item.foodId || item.food?.id;
    if (foodId) {
      try {
        const food = await api(`/foods/${foodId}`);
        await api(`/foods/${foodId}`, {
          method: 'PUT',
          body: { ...food, labelId: labelId || null },
        });
      } catch (e) {
        console.warn('Could not update food label:', e);
      }
    }
    await refreshList();
  } catch (err) {
    item.labelId = oldLabelId;
    item.label = oldLabel;
    renderShoppingList();
    toast('Failed to update category');
  }
}

// ─── Pull to refresh ───
function setupPullToRefresh() {
  const scroll = document.getElementById('shopping-scroll');
  let startY = 0;
  let pulling = false;

  scroll.addEventListener('touchstart', (e) => {
    if (scroll.scrollTop === 0) {
      startY = e.touches[0].clientY;
      pulling = true;
    }
  }, { passive: true });

  scroll.addEventListener('touchmove', (e) => {
    if (!pulling) return;
    const diff = e.touches[0].clientY - startY;
    const indicator = document.getElementById('pull-indicator');
    if (diff > 60) {
      indicator.style.display = 'block';
      indicator.textContent = '↓ Release to refresh';
    } else if (diff > 0) {
      indicator.style.display = 'block';
      indicator.textContent = '↓ Pull to refresh';
    }
  }, { passive: true });

  scroll.addEventListener('touchend', () => {
    if (!pulling) return;
    const indicator = document.getElementById('pull-indicator');
    if (indicator.textContent.includes('Release')) {
      indicator.textContent = 'Refreshing...';
      refreshList().then(() => {
        indicator.style.display = 'none';
      });
    } else {
      indicator.style.display = 'none';
    }
    pulling = false;
  });
}

// ─── Keyboard navigation helpers ───
function highlightAcItem(items) {
  items.forEach((el, i) => el.classList.toggle('kb-active', i === acKbIndex));
  if (acKbIndex >= 0) items[acKbIndex].scrollIntoView({ block: 'nearest' });
}
function highlightMpItem(items) {
  items.forEach((el, i) => el.classList.toggle('kb-active', i === mpKbIndex));
  if (mpKbIndex >= 0) items[mpKbIndex].scrollIntoView({ block: 'nearest' });
}

// ─── Label modal search ───
function filterLabelModal() {
  const query = document.getElementById('label-search-input').value.trim();
  const queryLower = query.toLowerCase();
  const items = document.querySelectorAll('#label-modal-list .label-modal-item:not(.lm-create)');
  let exactMatch = false;
  items.forEach(el => {
    const name = el.textContent.toLowerCase().trim();
    const matches = name.includes(queryLower);
    el.style.display = matches ? '' : 'none';
    if (matches && name.replace('✓', '').trim() === queryLower) exactMatch = true;
  });
  // Show or hide the "create" option
  let createEl = document.querySelector('#label-modal-list .lm-create');
  if (query.length >= 2 && !exactMatch) {
    if (!createEl) {
      createEl = document.createElement('div');
      createEl.className = 'label-modal-item lm-create';
      document.getElementById('label-modal-list').appendChild(createEl);
    }
    createEl.innerHTML = `<span class="lm-check">+</span> Create "${escHtml(query)}"`;
    createEl.onclick = () => createLabel(query);
    createEl.style.display = '';
  } else if (createEl) {
    createEl.style.display = 'none';
  }
}

async function createLabel(name) {
  try {
    const newLabel = await api('/groups/labels', {
      method: 'POST',
      body: { name },
    });
    // Add to local state
    allLabels.push(newLabel);
    labelMap[newLabel.id] = newLabel;
    populateCategoryOverride();
    toast(`Created "${name}"`);
    // Apply the new label to the item being edited
    if (labelEditItemId) {
      setItemLabel(newLabel.id);
    } else {
      closeLabelModal();
    }
  } catch (err) {
    toast('Failed to create category');
  }
}

// ─── Icons ───
function initIcons() {
  if (window.lucide) lucide.createIcons();
}

// ─── Service Worker ───
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js').catch(() => {});
}

// Initialize icons after DOM + Lucide loaded
document.addEventListener('DOMContentLoaded', () => setTimeout(initIcons, 50));
</script>
</body>
</html>
